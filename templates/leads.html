{% extends "base.html" %}
{% block title %}Leads Â· CALTAURA{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">Leads</h1>
    <div class="text-muted">Central list of captured prospects from calls, forms, and outreach.</div>
  </div>
  <div class="d-flex gap-2">
    <form class="d-flex gap-2" method="get" action="{{ url_for('leads') }}">
      <input class="form-control" name="q" placeholder="Search name, email, phone..." value="{{ request.args.get('q','') }}">
      <select class="form-select" name="status" style="max-width: 180px;">
        {% set s = request.args.get('status','') %}
        <option value="" {% if s=='' %}selected{% endif %}>All statuses</option>
        <option value="new" {% if s=='new' %}selected{% endif %}>New</option>
        <option value="contacted" {% if s=='contacted' %}selected{% endif %}>Contacted</option>
        <option value="qualified" {% if s=='qualified' %}selected{% endif %}>Qualified</option>
        <option value="won" {% if s=='won' %}selected{% endif %}>Won</option>
        <option value="lost" {% if s=='lost' %}selected{% endif %}>Lost</option>
      </select>
      <button class="btn btn-outline-light" type="submit">Filter</button>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead>
          <tr>
            <th class="ps-3">Lead</th>
            <th>Contact</th>
            <th>Status</th>
            <th>Source</th>
            <th>Created</th>
            <th class="text-end pe-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% set rows = leads if leads is defined else [] %}
          {% if rows|length == 0 %}
            <tr>
              <td colspan="6" class="p-4 text-muted">
                No leads found. If this is unexpected, verify your call webhook is generating lead records.
              </td>
            </tr>
          {% else %}
            {% for lead in rows %}
              {% set status = (lead.status if lead.status is defined else 'new') %}
              {% set badge = 'secondary' %}
              {% if status == 'new' %}{% set badge = 'info' %}{% endif %}
              {% if status == 'contacted' %}{% set badge = 'warning' %}{% endif %}
              {% if status == 'qualified' %}{% set badge = 'primary' %}{% endif %}
              {% if status == 'won' %}{% set badge = 'success' %}{% endif %}
              {% if status == 'lost' %}{% set badge = 'danger' %}{% endif %}

              <tr>
                <td class="ps-3">
                  <div class="fw-semibold">{{ lead.name if lead.name is defined else ('Lead #' ~ lead.id) }}</div>
                  <div class="text-muted small">{{ lead.company if lead.company is defined else '' }}</div>
                </td>
                <td>
                  <div class="small">
                    {% if lead.email is defined and lead.email %}<div>{{ lead.email }}</div>{% endif %}
                    {% if lead.phone is defined and lead.phone %}<div class="text-muted">{{ lead.phone }}</div>{% endif %}
                  </div>
                </td>
                <td><span class="badge text-bg-{{ badge }}">{{ status|capitalize }}</span></td>
                <td class="text-muted small">{{ lead.source if lead.source is defined else 'unknown' }}</td>
                <td class="text-muted small">
                  {{ lead.created_at if lead.created_at is defined else '' }}
                </td>
                <td class="text-end pe-3">
                  <a class="btn btn-sm btn-outline-light" href="{{ url_for('lead_detail', lead_id=lead.id) }}">Open</a>
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
