{% extends "base.html" %}
{% block title %}Lead · CALTAURA{% endblock %}

{% block content %}
{% set L = lead if lead is defined else None %}

<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
  <div>
    <a class="text-muted small" href="{{ url_for('leads') }}">← Back to Leads</a>
    <h1 class="h4 mb-1">{{ L.name if L and L.name is defined else 'Lead Detail' }}</h1>
    <div class="text-muted">
      {{ (L.company if L and L.company is defined else '') }}
      {% if L and L.source is defined and L.source %} · Source: {{ L.source }}{% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-light" href="{{ url_for('leads') }}">Close</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body p-4">
        <h2 class="h6">Contact</h2>
        <div class="text-muted small mb-3">Primary information for follow-up.</div>

        <div class="mb-2">
          <div class="text-muted small">Email</div>
          <div>{{ L.email if L and L.email is defined else '' }}</div>
        </div>
        <div class="mb-2">
          <div class="text-muted small">Phone</div>
          <div>{{ L.phone if L and L.phone is defined else '' }}</div>
        </div>
        <div class="mb-2">
          <div class="text-muted small">Status</div>
          <div class="fw-semibold">{{ L.status if L and L.status is defined else 'new' }}</div>
        </div>

        <hr class="my-4" style="border-color: rgba(255,255,255,.10);">

        <form method="post" action="{{ url_for('lead_update', lead_id=L.id) if L and L.id is defined else '' }}">
          <h2 class="h6">Update status</h2>
          <select class="form-select mb-3" name="status">
            {% set st = (L.status if L and L.status is defined else 'new') %}
            <option value="new" {% if st=='new' %}selected{% endif %}>New</option>
            <option value="contacted" {% if st=='contacted' %}selected{% endif %}>Contacted</option>
            <option value="qualified" {% if st=='qualified' %}selected{% endif %}>Qualified</option>
            <option value="won" {% if st=='won' %}selected{% endif %}>Won</option>
            <option value="lost" {% if st=='lost' %}selected{% endif %}>Lost</option>
          </select>
          <button class="btn btn-primary w-100" type="submit">Save</button>
        </form>

      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card mb-3">
      <div class="card-body p-4">
        <h2 class="h6 mb-1">Notes</h2>
        <div class="text-muted small mb-3">Track context, objections, next steps.</div>

        <form method="post" action="{{ url_for('lead_note_add', lead_id=L.id) if L and L.id is defined else '' }}">
          <textarea class="form-control mb-3" name="note" rows="4" placeholder="Add a note..."></textarea>
          <div class="d-flex justify-content-end">
            <button class="btn btn-outline-light" type="submit">Add note</button>
          </div>
        </form>

        <hr class="my-4" style="border-color: rgba(255,255,255,.10);">

        {% set notes = lead_notes if lead_notes is defined else [] %}
        {% if notes|length == 0 %}
          <div class="text-muted">No notes yet.</div>
        {% else %}
          <div class="d-grid gap-2">
            {% for n in notes %}
              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div class="text-muted small">{{ n.created_at if n.created_at is defined else '' }}</div>
                    <div class="text-muted small">{{ n.author if n.author is defined else '' }}</div>
                  </div>
                  <div class="mt-2">{{ n.text if n.text is defined else n }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-body p-4">
        <h2 class="h6 mb-1">Call activity</h2>
        <div class="text-muted small mb-3">Inbound call logs linked to this lead (if available).</div>

        {% set calls = call_logs if call_logs is defined else [] %}
        {% if calls|length == 0 %}
          <div class="text-muted">No call logs found for this lead.</div>
        {% else %}
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>From</th>
                  <th>Duration</th>
                  <th>Recording</th>
                </tr>
              </thead>
              <tbody>
                {% for c in calls %}
                  <tr>
                    <td class="text-muted small">{{ c.created_at if c.created_at is defined else '' }}</td>
                    <td>{{ c.from_number if c.from_number is defined else '' }}</td>
                    <td class="text-muted small">{{ c.duration if c.duration is defined else '' }}</td>
                    <td>
                      {% if c.recording_url is defined and c.recording_url %}
                        <a class="btn btn-sm btn-outline-light" href="{{ c.recording_url }}" target="_blank">Open</a>
                      {% else %}
                        <span class="text-muted small">—</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}
